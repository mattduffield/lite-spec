function y(d){let l={},m=/(\w+):\s*"([^"]*)"/g,s=d.matchAll(m);if(!s)throw new Error("Invalid permission expression format!");for(let a of s)l[a[1]]=a[2];return l}function w(d){let l=/@if\(([^:]+):\s*(.*?\(.*,*\)*?),\s*(.*?)\)$/;if(!d.match(l))throw new Error("Invalid IF expression format!");let[s,a,p,e]=d.match(l),t=p.match(/@\w+(\(.*?\))?/g)||[],i=e.match(/@\w+(\(.*?\))?/g)||[],r={if:{required:[a],properties:{[a]:{}}},then:{}};for(let o=0;o<t.length;o++){let c=/(@[a-zA-Z0-9_]+)\(([^)]+)\)/,f=t[o].match(c),[u,h,n]=f;n.startsWith('"')&&n.endsWith('"')?n=n.slice(1,-1):n==="true"?n=!0:n==="false"?n=!1:isNaN(n)||(n=Number(n)),h=="@enum"&&(n=n.split(","),n=n.map(x=>x.replace('"',"").trim())),r.if.properties[a][h.replace("@","")]=n}for(let o=0;o<i.length;o++){let c=/(@[a-zA-Z0-9_]+)\(([^)]+)\)/,f=i[o].match(c),[u,h,n]=f;h==="@required"?(r.then.hasOwnProperty("required")||(r.then.required=[]),r.then.required.push(n)):r.then[h.replace("@","")]=n}return r}function g(d,l,m,s,a,p){d.forEach(e=>{if(e.startsWith("@can")){let t=this.handlePermExpression(e);p.push({[l]:t})}else if(e.startsWith("@enum")){let t=m.match(/@enum\((.*?)\)/)[1];s.enum=t.split(",").map(i=>i.trim())}else if(e.startsWith("@ref")){let t=m.match(/@ref\((.*?)\)/)[1];s.$ref=`#/$defs/${t.toLowerCase()}`}else if(e.startsWith("@required"))a.requiredFields.push(l);else if(e.startsWith("@minItems"))s.minItems=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@maxItems"))s.maxItems=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@uniqueItems"))s.uniqueItems=!0;else if(e.startsWith("@minLength"))s.minLength=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@maxLength"))s.maxLength=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@exclusiveMinimum"))s.exclusiveMinimum=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@exclusiveMaximum"))s.exclusiveMaximum=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@minimum"))s.minimum=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@maximum"))s.maximum=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@multipleOf"))s.multipleOf=parseInt(e.match(/\d+/)[0]);else if(e.startsWith("@format"))e.match(/\((.*?)\)/)[1]=="date-time"?(s.anyOf=[{type:"string",format:"date-time"},{type:"string",enum:[""]}],delete s.type):s.format=e.match(/\((.*?)\)/)[1];else if(e.startsWith("@default")){let t=e.match(/\((.*?)\)/)[1];if(t==="true"||t==="false")s.default=t==="true";else if(isNaN(t))s.default=t;else{let i=t.match(/\.(\d+)/),r=i?i[1].length:0,o=parseFloat(t).toFixed(r);s.default=parseFloat(o)}}})}function b(d){let l=d.split(`
`).map(i=>i.trim()).filter(i=>i!==""),m={$defs:{}},s=[],a={},p=[],e=[],t=m;return l.forEach(i=>{if(i.startsWith("def ")){let[r,o]=i.match(/def (\w+) (object|array)/).slice(1),c;s=[],a={},p=[],o==="object"?c={type:"object",properties:{}}:o==="array"&&(c={type:"array",items:{type:"object",properties:{}}}),m.$defs[r.toLowerCase()]=c,t=c.type==="object"?c:c.items,e.push({object:t,requiredFields:[]})}else if(i.startsWith("model ")){let r=i.match(/model (\w+)/)[1];s=[],a={},p=[],m.title=r.toLowerCase(),m.type="object",m.properties={},t=m,e.push({object:t,requiredFields:[]})}else if(i.startsWith("}")){let r=e.pop();t=r.object,r.requiredFields.length>0&&(t.required=r.requiredFields),s.length>0&&(t.allOf=s),Object.entries(a).length>0&&(t.hasOwnProperty("permissions")||(t.permissions={}),t.permissions.collection=a),p.length>0&&(t.hasOwnProperty("permissions")||(t.permissions={}),t.permissions.field=p),e.length>0&&(t=e[e.length-1].object)}else if(i.startsWith("@if")){let r=this.handleIfExpression(i);s.push(r)}else if(i.startsWith("@can"))a=this.handlePermExpression(i);else if(i.includes("array(")){let[r,o]=i.split(":").map(u=>u.trim()),c=o.match(/@\w+(\(.*?\))?/g)||[],f=i.match(/array\((\w+)\)/);if(f){let h={type:"array",items:{type:f[1]}},n=e[e.length-1];this.handleAttributes(c,r,o,h,n,p),t.properties[r]=h}}else{let r=i.substring(0,i.indexOf(":")).trim(),o=i.substring(i.indexOf(":")+1).trim(),c=o.match(/@\w+(\(.*?\))?/g)||[],f=o.split("@")[0].trim(),u={};f=="decimal"?u.bsonType="Decimal128":u.type=f;let h=e[e.length-1];this.handleAttributes(c,r,o,u,h,p),t.properties[r]=u}}),m}window.ls||(window.ls={});window.ls.handlePermExpression=y;window.ls.handleIfExpression=w;window.ls.handleAttributes=g;window.ls.parseDSL=b;
